{% extends 'core/base.html' %}
{% load static %}
{% block content %}
    {% include 'core/menu.html' %}
    {% include 'core/mensagens.html' %}

    <!--MERCADO PAGO SDK-->
    <script src="https://sdk.mercadopago.com/js/v2"></script>

    <!--FORMULÁRIO PARA PAGAMENTO-->
    <div class="container mt-5">
        <div class="row">
            <!--INFORMAÇÕES DO PRODUTO-->
            <div class="col-6">
                <h2>Informações do produto</h2>
            </div>

            <!--FORMULÁRIO DE PAGAMENTO-->
            <div id="cardPaymentBrick_container" class="col-6"></div>
        </div>
    </div>

    <!--INICIALIZA FORM DE PAGAMENTO-->
    <script>
        const mp = new MercadoPago('APP_USR-1f68dd69-e308-43d3-9eeb-dc30958d5db9', {
          locale: 'pt-BR'
        });
        const bricksBuilder = mp.bricks();
        const renderCardPaymentBrick = async (bricksBuilder) => {
          const settings = {
            initialization: {
              amount: 10, // valor total a ser pago
              payer: {
                email: "",
              },
            },
            customization: {
              visual: {
                style: {
                  customVariables: {
                    theme: 'default', // | 'dark' | 'bootstrap' | 'flat'
                    texts: {
						formTitle: "Cartão de crédito",
                    }
                  }
                }
              },
                paymentMethods: {
                  types: {
                    excluded: ['debit_card']
                  }, 
                  maxInstallments: 1,
                }
            },
            callbacks: {
              onReady: () => {
                // callback chamado quando o Brick estiver pronto
              },
              onSubmit: (cardFormData) => {
                //  callback chamado o usuário clicar no botão de submissão dos dados
                //  exemplo de envio dos dados coletados pelo Brick para seu servidor
                return new Promise((resolve, reject) => {
                  fetch("/pedidos/pagar/", {
                    method: "POST",
                    headers: {
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(cardFormData)
                  })
                    .then((response) => {
                        // Verifica o resultado do pagamento
                        if (response.status === 201) {
                            // Pagamento bem-sucedido, redirecione para a página de sucesso
                            console.log('Pagamento bem-sucedido, redirecione para a página de sucesso')
                            window.location.href = "/card/criar/";
                        } else {
                            // Trate outros cenários de resposta aqui, como erros
                            // Pode redirecionar para uma página de erro, se aplicável
                            console.log('Pagamento falhou')
                            window.location.href = "/";
    }
                      resolve();
                    })
                    .catch((error) => {
                      // lidar com a resposta de erro ao tentar criar o pagamento
                      reject();
                    })
                });
              },
              onError: (error) => {
                // callback chamado para todos os casos de erro do Brick
              },
            },
          };
          window.cardPaymentBrickController = await bricksBuilder.create('cardPayment', 'cardPaymentBrick_container', settings);
        };
        renderCardPaymentBrick(bricksBuilder);
    </script>

{% endblock %}